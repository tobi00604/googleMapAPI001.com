<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マップ矩形領域クイズ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        #map {
            flex: 1;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
        }
        .info-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
        }
        .info-right {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
        }
        .save-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .save-form input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .save-form button {
            padding: 8px 16px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-form button:hover {
            background-color: #3367D6;
        }
        .save-form button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .saved-areas {
            margin-top: 10px;
            overflow-y: auto;
            max-height: 300px;
        }
        .saved-area-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .saved-area-item:last-child {
            border-bottom: none;
        }
        .load-btn {
            padding: 4px 8px;
            background-color: #34A853;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .load-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .delete-btn {
            padding: 4px 8px;
            background-color: #EA4335;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .delete-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #quiz-area {
            padding: 15px;
            border-radius: 5px;
        }
        #quiz-result {
            font-weight: bold;
            margin-top: 10px;
        }
        .quiz-btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: 120px;
        }
        #quiz-button {
            background-color: #FBBC05;
        }
        #quiz-button:hover {
            background-color: #F9A825;
        }
        #quiz-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #end-quiz {
            background-color: #4285F4;
            margin-left: 10px;
        }
        #end-quiz:hover {
            background-color: #3367D6;
        }
        #end-quiz:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>マップ矩形領域クイズ</h1>
    <div id="map"></div>
    <div id="info">
        <div class="info-left">
            <div class="save-form">
                <input type="text" id="area-name" placeholder="領域の名前を入力" />
                <button id="save-button">この名前で領域をリストに追加</button>
            </div>
            <div class="saved-areas" id="saved-areas-list">
                <!-- 保存された領域がここに表示されます -->
            </div>
        </div>
        <div class="info-right">
            <div id="quiz-area">
                <div style="display: flex;">
                    <button id="quiz-button" class="quiz-btn">クイズを出題</button>
                    <button id="end-quiz" class="quiz-btn" disabled>クイズを終了</button>
                </div>
                <div id="quiz-content" style="margin-top: 10px; display: none;">
                    <p>地図上をクリックして<strong id="quiz-target"></strong>にマーカーを置こう！</p>
                    <p id="quiz-result"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Maps APIの初期化
        let map;
        let clickCount = 0;
        let firstPosition = null;
        let secondPosition = null;
        let markers = [];
        let rectangle = null;
        let savedAreas = []; // メモリ内でのみ保持するリスト
        let quizMode = false;
        let currentQuizArea = null;
        let lastQuizAreaId = null; // 前回出題したクイズの領域ID
        let quizMarker = null;
        let quizAnswered = false; // 正解したかどうかのフラグ
        
        // マーカーを全て消去する関数
        function clearMarkers() {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }
        
        // 長方形を消去する関数
        function clearRectangle() {
            if (rectangle) {
                rectangle.setMap(null);
                rectangle = null;
            }
        }
        
        // 2点から長方形を描画する関数
        function drawRectangle(pos1, pos2) {
            // 北東と南西の座標を計算
            const bounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(
                    Math.min(pos1.lat, pos2.lat),
                    Math.min(pos1.lng, pos2.lng)
                ),
                new google.maps.LatLng(
                    Math.max(pos1.lat, pos2.lat),
                    Math.max(pos1.lng, pos2.lng)
                )
            );
            
            // 長方形を作成
            rectangle = new google.maps.Rectangle({
                bounds: bounds,
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.1,
                map: map
            });
        }
        
        function initMap() {
            // 日本列島が見える程度に地図を初期化
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 37.5, lng: 137.5 },
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.SATELLITE,
                // 地図/衛星写真切り替えボタンを非表示
                mapTypeControl: false,
                // ストリートビューボタンを非表示
                streetViewControl: false,
                styles: [
                    {
                        featureType: "all",
                        elementType: "labels",
                        stylers: [
                            { visibility: "off" }
                        ]
                    }
                ]
            });
            
            // クリックイベントの追加
            map.addListener("click", (e) => {
                if (quizMode) {
                    // クイズモード時のクリックイベント
                    handleQuizClick(e);
                    return;
                }
                
                clickCount++;
                
                if (clickCount === 1) {
                    // マーカーとレクタングルをクリア
                    clearMarkers();
                    clearRectangle();
                    
                    // 1回目のクリック
                    firstPosition = {
                        lat: e.latLng.lat(),
                        lng: e.latLng.lng()
                    };
                    
                    // マーカーを設置
                    const marker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        title: "1回目のクリック位置",
                        label: "1"
                    });
                    markers.push(marker);
                    
                } else if (clickCount === 2) {
                    // 2回目のクリック
                    secondPosition = {
                        lat: e.latLng.lat(),
                        lng: e.latLng.lng()
                    };
                    
                    // マーカーを設置
                    const marker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        title: "2回目のクリック位置",
                        label: "2"
                    });
                    markers.push(marker);
                    
                    // 長方形を描画
                    drawRectangle(firstPosition, secondPosition);
                    
                    // カウンターをリセット（次の2回のクリックを準備）
                    clickCount = 0;
                }
            });
            
            // 保存ボタンのイベントリスナーを追加
            document.getElementById("save-button").addEventListener("click", saveArea);
            
            // クイズボタンのイベントリスナーを追加
            document.getElementById("quiz-button").addEventListener("click", startQuiz);
            
            // クイズ終了ボタンのイベントリスナーを追加
            document.getElementById("end-quiz").addEventListener("click", endQuiz);
            
            // 初回表示更新
            displaySavedAreas();
        }
        
        // 領域を保存する関数
        function saveArea() {
            // 両方の位置が設定されているか確認
            if (!firstPosition || !secondPosition) {
                alert("2点をクリックして領域を指定してください。");
                return;
            }
            
            // 名前の入力を取得
            const areaName = document.getElementById("area-name").value.trim();
            if (!areaName) {
                alert("領域の名前を入力してください。");
                return;
            }
            
            // 名前の重複チェック
            const isDuplicate = savedAreas.some(area => area.name === areaName);
            if (isDuplicate) {
                alert("その名前は既に使用されています。別の名前を入力してください。");
                return;
            }
            
            // 領域データを作成
            const areaData = {
                id: Date.now(), // 一意のIDとして現在のタイムスタンプを使用
                name: areaName,
                point1: firstPosition,
                point2: secondPosition
            };
            
            // メモリ上の配列に直接追加
            savedAreas.push(areaData);
            
            // 入力フィールドをクリア
            document.getElementById("area-name").value = "";
            
            // 保存された領域リストを更新
            displaySavedAreas();
        }
        
        // 保存された領域をリストに表示する関数
        function displaySavedAreas() {
            const savedAreasList = document.getElementById("saved-areas-list");
            savedAreasList.innerHTML = "";
            
            if (savedAreas.length === 0) {
                savedAreasList.innerHTML = "<p>保存された領域はありません。</p>";
                return;
            }
            
            savedAreas.forEach(area => {
                const areaItem = document.createElement("div");
                areaItem.className = "saved-area-item";
                
                areaItem.innerHTML = `
                    <span>${area.name}</span>
                    <div>
                        <button class="load-btn" data-id="${area.id}">表示</button>
                        <button class="delete-btn" data-id="${area.id}">削除</button>
                    </div>
                `;
                
                savedAreasList.appendChild(areaItem);
            });
            
            // 読み込みボタンのイベントリスナーを追加
            document.querySelectorAll(".load-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const areaId = parseInt(this.getAttribute("data-id"));
                    loadArea(areaId);
                });
            });
            
            // 削除ボタンのイベントリスナーを追加
            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const areaId = parseInt(this.getAttribute("data-id"));
                    deleteArea(areaId);
                });
            });
            
            // クイズモード中は操作ボタンを非活性化
            toggleButtonsState(quizMode);
        }
        
        // ボタンの有効/無効を切り替える関数
        function toggleButtonsState(disabled) {
            // 追加ボタン
            document.getElementById("save-button").disabled = disabled;
            // 入力フィールド
            document.getElementById("area-name").disabled = disabled;
            // 枠表示と削除ボタン
            document.querySelectorAll(".load-btn, .delete-btn").forEach(button => {
                button.disabled = disabled;
            });
            // クイズボタン
            document.getElementById("quiz-button").disabled = disabled;
            // クイズ終了ボタン - 通常モードでは無効、クイズモードでは有効
            document.getElementById("end-quiz").disabled = !disabled;
        }
        
        // 保存された領域を読み込む関数
        function loadArea(areaId) {
            const area = savedAreas.find(area => area.id === areaId);
            if (!area) return;
            
            // 既存のマーカーと長方形をクリア
            clearMarkers();
            clearRectangle();
            
            // 保存された位置を設定
            firstPosition = area.point1;
            secondPosition = area.point2;
            
            // マーカーを追加
            const marker1 = new google.maps.Marker({
                position: new google.maps.LatLng(firstPosition.lat, firstPosition.lng),
                map: map,
                title: "1回目のクリック位置",
                label: "1"
            });
            markers.push(marker1);
            
            const marker2 = new google.maps.Marker({
                position: new google.maps.LatLng(secondPosition.lat, secondPosition.lng),
                map: map,
                title: "2回目のクリック位置",
                label: "2"
            });
            markers.push(marker2);
            
            // 長方形を描画
            drawRectangle(firstPosition, secondPosition);
            
            // 地図の表示範囲を調整
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(new google.maps.LatLng(firstPosition.lat, firstPosition.lng));
            bounds.extend(new google.maps.LatLng(secondPosition.lat, secondPosition.lng));
            map.fitBounds(bounds);
            
            // クリックカウンターをリセット
            clickCount = 0;
        }
        
        // 保存された領域を削除する関数
        function deleteArea(areaId) {
            // 該当する領域を除外
            savedAreas = savedAreas.filter(area => area.id !== areaId);
            
            // 表示を更新
            displaySavedAreas();
        }
        
        // クイズを開始する関数
        function startQuiz() {
        
            // 保存された領域が少なすぎる場合
            if (savedAreas.length < 3) {
                alert("クイズを始めるには、少なくとも3つの領域を保存してください。");
                return;
            }
            
            // 前回と異なる領域をランダムに選択する
            let availableAreas = savedAreas;
            if (lastQuizAreaId !== null) {
                availableAreas = savedAreas.filter(area => area.id !== lastQuizAreaId);
            }
            
            // クイズモードをオンに
            quizMode = true;
            // 正解フラグをリセット
            quizAnswered = false;
            
            // ボタンを非活性化
            toggleButtonsState(true);
            
            // マーカーとレクタングルをクリア
            clearMarkers();
            clearRectangle();
            
            // クイズコンテンツエリアを表示
            document.getElementById("quiz-content").style.display = "block";
            
            // ランダムに領域を選択（前回と違うもの）
            const randomIndex = Math.floor(Math.random() * availableAreas.length);
            currentQuizArea = availableAreas[randomIndex];
            lastQuizAreaId = currentQuizArea.id;
            
            // 選択された領域名を表示
            document.getElementById("quiz-target").textContent = currentQuizArea.name;
            document.getElementById("quiz-result").textContent = "";
        }
        
        // クイズモード時のクリックを処理する関数
        function handleQuizClick(e) {
            // 既に正解している場合は何もしない
            if (quizAnswered) {
                return;
            }
            
            // 既存のクイズマーカーがあれば削除
            if (quizMarker) {
                quizMarker.setMap(null);
            }
            
            // クリック位置
            const clickPosition = {
                lat: e.latLng.lat(),
                lng: e.latLng.lng()
            };
            
            // マーカーを設置
            quizMarker = new google.maps.Marker({
                position: e.latLng,
                map: map,
                title: "あなたの回答",
                animation: google.maps.Animation.DROP
            });
            
            // クリックした位置が領域内かチェック
            checkQuizAnswer(clickPosition);
        }
        
        // クイズの回答をチェックする関数
        function checkQuizAnswer(position) {
            // 現在のクイズエリアから境界を計算
            const bounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(
                    Math.min(currentQuizArea.point1.lat, currentQuizArea.point2.lat),
                    Math.min(currentQuizArea.point1.lng, currentQuizArea.point2.lng)
                ),
                new google.maps.LatLng(
                    Math.max(currentQuizArea.point1.lat, currentQuizArea.point2.lat),
                    Math.max(currentQuizArea.point1.lng, currentQuizArea.point2.lng)
                )
            );
            
            // クリック位置が境界内かチェック
            const isInside = bounds.contains(
                new google.maps.LatLng(position.lat, position.lng)
            );
            
            // 結果表示
            const resultElement = document.getElementById("quiz-result");
            if (isInside) {
                resultElement.textContent = "正解です！";
                resultElement.style.color = "#34A853";
                
                // 正解の場合、領域を表示
                drawRectangle(currentQuizArea.point1, currentQuizArea.point2);
                
                // 正解フラグをセット
                quizAnswered = true;
            } else {
                resultElement.textContent = "残念…、場所が違います。マーカーを置き直してください！";
                resultElement.style.color = "#EA4335";
            }
        }
        
        // クイズを終了する関数
        function endQuiz() {
            // クイズモード終了
            quizMode = false;
            
            // ボタンを有効化
            toggleButtonsState(false);
            
            // クイズコンテンツエリアを非表示
            document.getElementById("quiz-content").style.display = "none";
            
            // マーカーとレクタングルをクリア
            if (quizMarker) {
                quizMarker.setMap(null);
                quizMarker = null;
            }
            clearRectangle();
            
            // クイズ結果をクリア
            document.getElementById("quiz-result").textContent = "";
            currentQuizArea = null;
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClsi_0c4v8zemkEpzJi5-BXFBbictsupY&callback=initMap" async defer></script>
</body>
</html>
